def APPLICATION = "nginx"
def ENVIRONMENT = "dev"
def CHECKOUT_REPO = "https://github.com/StavrosZacharia/devops-aws.git"

def REGION = "eu-central-1"
credentials = "thesis-project"

node(""){

    try {
        stage("Checkout"){
            STAGE = env.STAGE_NAME
            sh """ rm -rf *"""
            git branch: 'master', credentialsId: 'devops-jenkins', url: "${CHECKOUT_REPO}"
        }

        stage("Install terraform and plan"){
            STAGE = env.STAGE_NAME
                def terraformVersion = '1.7.1'
                sh "wget https://releases.hashicorp.com/terraform/${terraformVersion}/terraform_${terraformVersion}_linux_amd64.zip"
                sh "unzip -o terraform_${terraformVersion}_linux_amd64.zip"
                sh 'chmod +x terraform'
                sh 'sudo mv terraform /usr/local/bin/terraform'
                sh """rm terraform_1.7.1_linux_amd64.zip"""
                sh 'terraform version'
                sh """ ls """
                withCredentials([aws(accessKeyVariable:'AWS_ACCESS_KEY_ID', credentialsId: credentials, secretKeyVariable: 'AWS_SECRET_ACCESS_KEY')]){
                sh """cd infra && \
                    ls && \
                    terraform init && terraform plan """
                }
        }

        stage("Apply AWS changes"){
            withCredentials([aws(accessKeyVariable:'AWS_ACCESS_KEY_ID', credentialsId: credentials, secretKeyVariable: 'AWS_SECRET_ACCESS_KEY')]){
                sh """ cd infra && terraform apply --auto-approve """
            }
        }
        currentBuild.result = "SUCCESS"

    }catch (Exception e) {
        println "Failed at Stage:$STAGE"
        echo e.getMessage()
        currentBuild.result = "FAILURE"

    }
}